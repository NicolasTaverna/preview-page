<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Preview & Pay</title>
  <style>
    /* simple styling */
    body { font-family: Arial, sans-serif; text-align:center; margin:40px; background:#fafafa }
    img{ max-width:60%; max-height:300px; border-radius:12px; margin-bottom:20px; filter:blur(12px); }
    .amount-input{ width:120px; text-align:center; padding:8px; border-radius:6px; border:1px solid #ccc; }
    #paypal-button-container{ width:320px; margin: 0 auto; }
  </style>
</head>
<body>
  <h1>âœ¨ Your Edited Image Preview</h1>
  <p>This is a blurred preview. Pay what you want (min $5) to unlock the full-resolution image.</p>

  <img id="preview-image" src="" alt="Blurred preview">

  <div>
    <input id="amount" type="number" class="amount-input" value="5" min="5" step="1" />
  </div>

  <div id="paypal-button-container"></div>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const imageUrl = params.get('image');
    const orderRef = params.get('ref'); // your internal id prepared by n8n

    if (imageUrl) document.getElementById('preview-image').src = imageUrl;

    paypal.Buttons({
      createOrder: function(data, actions) {
        const amount = parseFloat(document.getElementById('amount').value);
        if (isNaN(amount) || amount < 5) { alert('Minimum is $5'); throw new Error('Invalid amount'); }

        // Create the order client-side and attach your orderRef as custom_id
        return actions.order.create({
          purchase_units: [{
            description: 'Unlock Full Resolution Image',
            custom_id: orderRef,
            amount: { currency_code: 'USD', value: amount.toFixed(2) }
          }]
        });
      },

      onApprove: function(data, actions) {
        // Capture and then notify Netlify function
        return actions.order.capture().then(function(details) {
          const orderId = details.id;

          // POST to Netlify function to verify and fetch Drive link
          fetch('/.netlify/functions/verify-paypal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderRef, orderId })
          })
          .then(r => r.json())
          .then(resp => {
            if (resp.success) {
              // Give user choice: redirect to direct download and also show view link
              // Option: auto download
              window.location.href = resp.directDownloadLink; // starts download where possible
              // also open view link in new tab
              window.open(resp.viewLink, '_blank');
            } else {
              alert('Payment verification failed: ' + (resp.error || 'unknown'));
            }
          })
          .catch(err => {
            console.error('verify error', err);
            alert('Verification service error, please contact support.');
          });
        });
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
